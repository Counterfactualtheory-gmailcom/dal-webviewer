<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DAL Answer (Android)</title>

  <style>
    :root{
      --wrap: 900px;
      --pad: 16px;
      --border: #e5e7eb;
      --accent: #f0c44c;
      --text: #ffffff;
      --bg: #0c2d5a;          /* DAL navy */
      --bg-page: #0c2d5a;
      --link: #9cc9ff;
      --link-visited: #c8e0ff;
      --muted:#a2b8df;
    }

    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: var(--bg-page);
      color: var(--text);
      font: 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .wrap { max-width: var(--wrap); margin: 0 auto; padding: var(--pad); }
    #out, #out *:not(a) { color: var(--text) !important; background: transparent !important; }
    a{ color: var(--link) !important; text-decoration: underline; cursor: pointer; }
    a:visited{ color: var(--link-visited) !important; }
    pre,code{white-space:pre-wrap;word-break:break-word}

    /* tiny inline log (top-right) */
    #log {
      position: sticky; top: 0; float: right;
      font-size: 12px; line-height: 1.2;
      color: var(--muted); opacity: .8;
      padding: 2px 6px; border-left: 3px solid var(--accent);
      background: rgba(0,0,0,.15);
      border-radius: 6px; max-width: 100%;
    }
  </style>

  <!-- Markdown + sanitize + linkify -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify-html.min.js"></script>

  <!-- Thunkable bridge -->
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>
<body>
  <div class="wrap">
    <div id="log">status: booting…</div>
    <div id="out">Loading...</div>
  </div>

  <script>
    // ---- helpers
    const $ = (id) => document.getElementById(id);
    const log = (t) => { const el = $('log'); el.textContent = t; };

    marked.setOptions({ gfm:true, breaks:true, mangle:false, headerIds:false });

    function renderMarkdown(md){
      const html = marked.parse(md || '');
      const clean = DOMPurify.sanitize(html, { ADD_ATTR: ['target','rel'] });
      const linked = linkifyHtml(clean, {
        defaultProtocol: 'https',
        validate: { url: (v) => /^https?:\/\//i.test(v) },
        attributes: { rel: 'noopener', target: '_blank' }
      });
      $('out').innerHTML = linked || '<span style="opacity:.7">[empty]</span>';
    }

    // ---- handshake: send ready; retry once after a tick
    function sendReady(){
      try { ThunkableWebviewerExtension.postMessage('ready-android'); log('sent: ready-android'); }
      catch(e){ log('error sending ready'); }
    }

    // Fire once DOM is ready (more reliable on Android)
    document.addEventListener('DOMContentLoaded', () => {
      log('dom ready; sending ready…');
      sendReady();
      setTimeout(() => { log('retry ready…'); sendReady(); }, 300);
    });

    // ---- receive and render payload
    ThunkableWebviewerExtension.receiveMessage(function(message){
      // If Thunkable echoes our 'ready-android', just ignore for rendering.
      if (message === 'ready-android') {
        log('got echo: ready-android');
        return;
      }
      log(`got payload (len: ${String(message||'').length})`);
      try {
        renderMarkdown(message);
        // acknowledge back so you can see it in your DEBUG label if desired
        try { ThunkableWebviewerExtension.postMessage('received-android'); } catch(_){}
      } catch (e) {
        $('out').textContent = 'Render error.';
        log('render error');
      }
    });

    // ---- link intercept: hand off to Thunkable to open in-app view
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a[href]');
      if (!a) return;
      e.preventDefault();
      const url = a.href;
      try {
        ThunkableWebviewerExtension.postMessage(JSON.stringify({ type:'open-url', url }));
        log('sent open-url');
      } catch (e) {
        // last-resort fallback: navigate inside webview
        location.href = url;
      }
    });

    // crash guard
    window.addEventListener('error', () => log('runtime error'));
  </script>
</body>
</html>
