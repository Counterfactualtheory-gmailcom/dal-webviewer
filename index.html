<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAL Answer Viewer</title>

  <style>
    :root{
      --text:#ffffff;
      --bg:#0c2d5a;       /* for typography contrast if transparency not supported */
      --border:#e5e7eb;
    }

    /* Make the iframe look like *no box* inside Thunkable */
    html,body{
      margin:0; padding:0;
      background:transparent;     /* try to be see-through */
      color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-text-size-adjust:100%;
    }
    /* Fallback if transparency isn’t honored by platform */
    .surface{ background:transparent; padding:0; }
    #out{ min-height:40vh; }

    a{ word-break:break-word; text-decoration:underline; color:#fff }
    a:visited{ color:#f5f5f5 }
    pre,code{ white-space:pre-wrap; word-break:break-word }
    blockquote{
      margin:0 0 1em 0; padding-left:12px;
      border-left:4px solid var(--border); color:#eef2ff
    }
    table{ border-collapse:collapse; width:100%; margin:.5em 0 }
    th,td{ border:1px solid var(--border); padding:8px; vertical-align:top }
    h1,h2,h3{ margin-top:1.2em }
    .muted{ opacity:.9; color:#dbe7ff }
    .debug{
      font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      white-space:pre-wrap; margin-top:8px; color:#bfe1ff; display:none;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify-html.min.js"></script>
</head>

<body>
  <!-- no borders, no rounded corners, no shadow -->
  <div class="surface">
    <div id="out">Waiting for content…</div>
    <div id="dbg" class="debug"></div>
  </div>

  <script>
    marked.setOptions({ gfm:true, breaks:true, mangle:false, headerIds:false });

    const outEl = document.getElementById('out');
    const dbgEl = document.getElementById('dbg');
    const showDebug = /[?&]debug=1\b/.test(location.search);
    function debug(m){ if(!showDebug) return; dbgEl.style.display='block'; dbgEl.textContent += (dbgEl.textContent?'\n':'')+m; }

    function stripControlTags(md){
      return String(md||'')
        .replace(/<<START ANSWER>>/g,'')
        .replace(/<<END ANSWER>>/g,'')
        .replace(/\s*\[COMPLETED\]\s*$/,'')
        .trim();
    }

    function safeRender(md){
      const raw = stripControlTags(md);
      const html = marked.parse(raw||''); debug('marked len='+html.length);
      const clean1 = DOMPurify.sanitize(html, { ADD_ATTR:['target','rel'] });
      let linked = clean1;
      try{
        if(typeof linkifyHtml==='function'){
          linked = linkifyHtml(clean1, {
            defaultProtocol:'https', nl2br:false,
            validate:{ url:v => /^https?:\/\//i.test(v) },
            attributes:{ rel:'noopener', target:'_blank' }
          });
        }
      }catch(e){ debug('linkify error: '+e); }
      const clean2 = DOMPurify.sanitize(linked, { ADD_ATTR:['target','rel'] });
      outEl.innerHTML = clean2 || '<span class="muted">[empty]</span>';
      outEl.querySelectorAll('a').forEach(a => { a.target='_blank'; a.rel='noopener'; });
    }

    let firstMessageReceived=false, readyPingerId=null;
    window.addEventListener('message', (e)=>{
      try{
        firstMessageReceived=true;
        if(readyPingerId){ clearInterval(readyPingerId); readyPingerId=null; }
        const payload = (e && e.data && e.data.payload) ? e.data.payload : e.data;
        safeRender(payload);
      }catch(err){ outEl.textContent='Render error: '+err; debug(String(err&&err.stack||err)); }
    }, false);

    function pingReady(){ try{ window.parent.postMessage('ready','*'); }catch(e){ debug('pm error: '+e); } }

    function hashTest(){
      if(location.hash && location.hash.length>1){
        const md = decodeURIComponent(location.hash.slice(1));
        safeRender(md);
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      hashTest(); pingReady();
      let tries=0;
      readyPingerId=setInterval(()=>{
        if(firstMessageReceived || tries>=10){ clearInterval(readyPingerId); readyPingerId=null; return; }
        pingReady(); tries++;
      },600);
    });
  </script>
</body>
</html>
