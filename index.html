<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DAL Answer Viewer</title>

<style>
  :root{
    --wrap:900px; --pad:16px;
    --text:#ffffff;              /* body text: white */
    --link:#cfe6ff;              /* links: light blue */
    --bg:transparent;            /* let Thunkable panel show through */
  }
  html,body{
    margin:0; padding:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-text-size-adjust:100%;
  }
  .wrap{max-width:var(--wrap); margin:0 auto; padding:var(--pad)}
  /* No inner border/background here—Thunks provides the outer panel */
  .surface{min-height:60vh; padding:var(--pad)}
  /* Force white text everywhere except links */
  #out, #out p, #out li, #out h1, #out h2, #out h3 { color: var(--text) !important; }
  a{ color:var(--link); text-decoration:underline; word-break:break-word }
  a:visited{ color:var(--link) }
  pre,code{ white-space:pre-wrap; word-break:break-word }
  blockquote{ margin:0 0 1em 0; padding-left:12px; border-left:4px solid rgba(255,255,255,.25) }
  table{ border-collapse:collapse; width:100%; margin:.6em 0 }
  th,td{ border:1px solid rgba(255,255,255,.25); padding:8px; vertical-align:top }
  h1,h2,h3{ margin-top:1.2em }
  .debug{ font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; white-space:pre-wrap; margin-top:8px; color:#bfe1ff; display:none }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify-html.min.js"></script>
<script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="surface">
      <div id="out">Waiting for content…</div>
      <div id="dbg" class="debug"></div>
    </div>
  </div>

<script>
  marked.setOptions({ gfm:true, breaks:true, mangle:false, headerIds:false });

  const outEl = document.getElementById('out');
  const dbgEl = document.getElementById('dbg');
  const showDebug = /[?&]debug=1\b/.test(location.search);
  const log = m => { if(showDebug){ dbgEl.style.display='block'; dbgEl.textContent += (dbgEl.textContent?'\n':'')+m; } };

  const strip = s => String(s||'')
    .replace(/<<START ANSWER>>/g,'')
    .replace(/<<END ANSWER>>/g,'')
    .replace(/\s*\[COMPLETED\]\s*$/,'')
    .trim();

  function render(md){
    const html = marked.parse(strip(md));
    const clean1 = DOMPurify.sanitize(html, { ADD_ATTR: ['target','rel'] });
    let linked = clean1;
    try{
      if(typeof linkifyHtml==='function'){
        linked = linkifyHtml(clean1, {
          defaultProtocol:'https', nl2br:false,
          validate:{ url:v=>/^https?:\/\//i.test(v) },
          attributes:{ rel:'noopener', target:'_blank' }
        });
      }
    }catch(e){ log('linkify error: '+e); }
    const clean2 = DOMPurify.sanitize(linked, { ADD_ATTR: ['target','rel'] });
    outEl.innerHTML = clean2 || '<em>[empty]</em>';
    outEl.querySelectorAll('a').forEach(a=>{ a.target='_blank'; a.rel='noopener'; });
  }

  // Thunkable handshake: keep pinging longer to cover Live timing
  let gotMsg = false, tries = 0, timer = null;
  function ping(){ try{ ThunkableWebviewerExtension.postMessage('ready'); }catch(e){ log('postMessage error: '+e); } }

  ThunkableWebviewerExtension.receiveMessage(function (msg){
    gotMsg = true;
    if(timer){ clearInterval(timer); timer=null; }
    const payload = (msg && typeof msg==='object' && 'payload' in msg) ? msg.payload : msg;
    log('received message; type='+(typeof payload)+' len='+(String(payload||'').length));
    render(payload);
  });

  // allow manual test via #hash
  function hashTest(){
    if(location.hash && location.hash.length>1){
      const md = decodeURIComponent(location.hash.slice(1));
      render(md);
    }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    hashTest();
    ping();
    // retry for ~20s to catch Live race conditions
    timer = setInterval(()=>{ if(gotMsg || tries>=32){ clearInterval(timer); timer=null; return; } ping(); tries++; }, 600);
  });
</script>
</body>
</html>
