<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAL Answer Viewer</title>
  <style>
    :root{
      --dal-blue:#002D72;      /* Dal brand blue */
      --dal-gold:#f0c44c;      /* accent */
      --wrap:900px;
      --pad:16px;
      --border:#e5e7eb;
      --bg:#002D72;            /* page background */
      --card:#0b3a8f;          /* deep blue card */
      --text:#ffffff;          /* white text */
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:var(--wrap);margin:0 auto;padding:var(--pad)}
    .card{background:var(--card);border:3px solid var(--dal-gold);border-radius:14px;padding:var(--pad)}
    a{color:var(--text); text-decoration:underline; word-break:break-word}
    pre,code{white-space:pre-wrap;word-break:break-word}
    blockquote{margin:0 0 1em 0;padding-left:12px;border-left:4px solid var(--dal-gold);opacity:.95}
    table{border-collapse:collapse;width:100%;margin:.5em 0}
    th,td{border:1px solid var(--border);padding:8px;vertical-align:top;color:var(--text)}
    h1,h2,h3{margin-top:1.2em}
    .muted{opacity:.9}
    .debug{font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;margin-top:8px;opacity:.9}
  </style>

  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="out" class="muted">Waiting for content…</div>
      <div id="dbg" class="debug" style="display:none"></div>
    </div>
  </div>

  <script>
    // --- Config ---
    marked.setOptions({ gfm:true, breaks:true, mangle:false, headerIds:false });

    const dbgEl = document.getElementById('dbg');
    const outEl = document.getElementById('out');
    const showDebug = /[?&]debug=1\b/.test(location.search);

    function debug(msg){
      if(!showDebug) return;
      dbgEl.style.display = 'block';
      dbgEl.textContent += (dbgEl.textContent ? '\n' : '') + msg;
    }

    function stripControlTags(md){
      return String(md || '')
        .replace(/<<START ANSWER>>/g,'')
        .replace(/<<END ANSWER>>/g,'')
        .replace(/\[COMPLETED\]\s*$/,'')
        .trim();
    }

    // Lightweight bare-URL linkifier (no external deps)
    function linkifyBareUrls(html){
      const urlRE = /(^|[\s(>])((https?:\/\/)[^\s<)]+)(?=$|[\s<)])/gi;
      return html.replace(urlRE, (m, pre, url) => {
        // avoid double-wrapping if already inside an anchor
        if (/<a\s/i.test(m)) return m;
        return `${pre}<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
      });
    }

    function renderMarkdown(md){
      const parsed = marked.parse( stripControlTags(md) );
      debug('marked html length=' + parsed.length);

      // sanitize, linkify, sanitize again
      const clean1 = DOMPurify.sanitize(parsed, { ADD_ATTR: ['target','rel'] });
      const linked = linkifyBareUrls(clean1);
      const clean2 = DOMPurify.sanitize(linked, { ADD_ATTR: ['target','rel'] });

      outEl.innerHTML = clean2;

      // enforce target/rel on any anchors
      outEl.querySelectorAll('a').forEach(a => { a.target = '_blank'; a.rel = 'noopener'; });
    }

    // Tell Thunkable we're ready (your block listens for "ready")
    function notifyReady(){
      try { window.parent.postMessage('ready','*'); debug('posted "ready" to parent'); }
      catch(e){ debug('postMessage error: ' + e); }
    }

    // Receive Markdown from Thunkable → render it.
    window.addEventListener('message', (e) => {
      try {
        const data = e && e.data;
        debug('received message type=' + (typeof data));
        // Ignore any accidental echo of "ready"
        if (data === 'ready') { debug('ignored echo "ready"'); return; }

        // Support plain string or {payload:"..."}
        const payload = (data && typeof data === 'object' && 'payload' in data) ? data.payload : data;

        if (typeof payload === 'string' && payload.trim()){
          renderMarkdown(payload);
        } else {
          debug('empty/invalid payload; nothing to render');
        }
      } catch(err){
        outEl.textContent = 'Render error: ' + err;
        debug('Render error: ' + (err && err.stack || err));
      }
    }, false);

    // Optional manual test via #hash
    function hashTest(){
      if (location.hash && location.hash.length > 1){
        const md = decodeURIComponent(location.hash.slice(1));
        debug('hash test length=' + md.length);
        renderMarkdown(md);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      notifyReady();
      hashTest();
    });
  </script>
</body>
</html>
