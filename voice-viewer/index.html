<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAL Voice Viewer</title>

  <style>
    :root {
      --wrap: 900px;
      --pad: 16px;
      --border: #e5e7eb;
      --accent: #f0c44c;   /* Dal gold */
      --text: #ffffff;     /* white text */
      --bg: #0c2d5a;       /* Dal navy */
      --bg-page: #0c2d5a;  /* background navy */
      --muted: #dbe7ff;
      --link: #9cc9ff;
      --link-visited: #c8e0ff;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-page);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap { max-width: var(--wrap); margin: 0 auto; padding: var(--pad); text-align: center; }
    button {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 10px;
      padding: 14px 20px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 16px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #out { margin-top: 24px; text-align: left; }
    a { color: var(--link); }
    a:visited { color: var(--link-visited); }
  </style>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h2>üéôÔ∏è DAL Voice Assistant</h2>
    <p>Press the button and speak your question.</p>
    <button id="micBtn">üé§ Press to Speak</button>
    <div id="out"><em>Waiting for input‚Ä¶</em></div>
  </div>

  <script>
    const backendURL = "https://dalbackendproduction-production.up.railway.app/ask";
    const micBtn = document.getElementById("micBtn");
    const outEl = document.getElementById("out");

    let recognition;
    let recognizing = false;
    let voices = [];

    window.speechSynthesis.onvoiceschanged = () => {
      voices = window.speechSynthesis.getVoices();
    };

    function speak(text) {
      if (!text) return;
      const utter = new SpeechSynthesisUtterance(stripTags(text));
      utter.lang = "en-CA";
      utter.rate = 1.0;
      utter.pitch = 1.0;
      const voice = voices.find(v => v.lang.startsWith("en")) || voices[0];
      if (voice) utter.voice = voice;
      speechSynthesis.speak(utter);
    }

    function stripTags(text) {
      const tmp = document.createElement("div");
      tmp.innerHTML = text;
      return tmp.textContent || tmp.innerText || "";
    }

    function startRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Speech recognition not supported in this browser.");
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-CA";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        recognizing = true;
        micBtn.textContent = "üéß Listening...";
        outEl.innerHTML = "<em>Listening...</em>";
      };

      recognition.onerror = (e) => {
        recognizing = false;
        micBtn.textContent = "üé§ Press to Speak";
        outEl.innerHTML = `<span style="color:#ffaaaa">Error: ${e.error}</span>`;
      };

      recognition.onresult = (e) => {
        recognizing = false;
        micBtn.textContent = "üé§ Press to Speak";
        const transcript = e.results[0][0].transcript;
        outEl.innerHTML = `<b>You said:</b> ${transcript}<br><em>Processing...</em>`;
        sendToBackend(transcript);
      };

      recognition.onend = () => {
        recognizing = false;
        micBtn.textContent = "üé§ Press to Speak";
      };

      recognition.start();
    }

    micBtn.addEventListener("click", () => {
      if (recognizing) {
        recognition.stop();
        micBtn.textContent = "üé§ Press to Speak";
        return;
      }
      startRecognition();
    });

    async function sendToBackend(question) {
      try {
        const payload = { question };
        const res = await fetch(backendURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        const answer = data.answer || "[No answer received]";
        const html = DOMPurify.sanitize(marked.parse(answer));
        outEl.innerHTML = `<b>Answer:</b><br>${html}`;
        speak(answer);
      } catch (err) {
        outEl.innerHTML = `<span style="color:#ffaaaa">Backend error: ${err}</span>`;
      }
    }
  </script>
</body>
</html>
